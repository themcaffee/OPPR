// Prisma schema for OPPR Database
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Player model - represents a pinball player
model Player {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Player identification
  externalId       String?  @unique // External ID from OPPR or other systems
  playerNumber     Int      @unique // 5-digit unique identifier (10000-99999)
  name             String?

  // General player statistics
  eventCount       Int      @default(0)     // Number of events participated
  lastEventDate    DateTime?

  // Relations
  standings            Standing[]
  user                 User?
  organizedTournaments Tournament[] @relation("OrganizedTournaments")
  opprRanking          OpprPlayerRanking?

  @@index([externalId])
  @@index([playerNumber])
}

// Tournament model - represents a pinball tournament event
model Tournament {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Tournament identification
  externalId       String?  @unique // External ID from OPPR or other systems
  externalUrl      String?          // URL to external tournament page (e.g., IFPA, Matchplay)
  name             String
  description      String?  @db.VarChar(2000)
  date             DateTime

  // Location relation
  locationId       String?
  location         Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  // Organizer relation
  organizerId      String?
  organizer        Player?   @relation("OrganizedTournaments", fields: [organizerId], references: [id], onDelete: SetNull)

  // Tournament configuration (stored as JSON)
  // Contains TGPConfig structure from OPPR
  tgpConfig        Json?

  // Event classification
  eventBooster     EventBoosterType @default(NONE)
  qualifyingFormat TournamentFormatType @default(NONE)
  allowsOptOut     Boolean          @default(false)

  // Tournament value calculations (can be calculated or cached)
  baseValue        Float?
  tvaRating        Float?
  tvaRanking       Float?
  totalTVA         Float?
  tgp              Float?
  eventBoosterMultiplier Float?
  firstPlaceValue  Float?

  // Relations
  standings             Standing[]
  rankingHistoryRecords OpprRankingHistory[]

  @@index([date])
  @@index([eventBooster])
  @@index([externalId])
  @@index([locationId])
  @@index([organizerId])
}

// Standing model - final position for qualifying or finals
model Standing {
  id               String     @id @default(cuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  tournamentId     String
  tournament       Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerId         String
  player           Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  position         Int        // Finishing position (1 = first place)
  isFinals         Boolean    @default(false)
  optedOut         Boolean    @default(false)

  // Points (calculated from merged standings)
  linearPoints     Float?     @default(0)
  dynamicPoints    Float?     @default(0)
  totalPoints      Float?
  ageInDays        Int?       @default(0)
  decayMultiplier  Float?     @default(1.0)
  decayedPoints    Float?
  efficiency       Float?

  @@unique([playerId, tournamentId, isFinals])
  @@index([playerId])
  @@index([tournamentId])
  @@index([tournamentId, isFinals])
  @@index([position])
}

// Enum for event booster types
enum EventBoosterType {
  NONE
  CERTIFIED
  CERTIFIED_PLUS
  CHAMPIONSHIP_SERIES
  MAJOR
}

// Enum for tournament format types (qualifying and finals)
enum TournamentFormatType {
  SINGLE_ELIMINATION
  DOUBLE_ELIMINATION
  MATCH_PLAY
  BEST_GAME
  CARD_QUALIFYING
  PIN_GOLF
  FLIP_FRENZY
  STRIKE_FORMAT
  TARGET_MATCH_PLAY
  HYBRID
  NONE
}

// Enum for user roles
enum Role {
  USER
  ADMIN
}

// Enum for blog post status
enum PostStatus {
  DRAFT
  PUBLISHED
}

// User model - represents an authenticated user account
model User {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Authentication
  email            String   @unique
  passwordHash     String

  // Authorization
  role             Role     @default(USER)

  // Link to Player profile
  playerId         String?  @unique
  player           Player?  @relation(fields: [playerId], references: [id], onDelete: SetNull)

  // Session management (for token revocation)
  refreshTokenHash String?

  // Policy acceptance timestamps (null = not accepted)
  tosAcceptedAt           DateTime?
  privacyPolicyAcceptedAt DateTime?
  codeOfConductAcceptedAt DateTime?

  // Blog posts authored by this user
  blogPosts               BlogPost[]

  // API Keys
  apiKeys          ApiKey[]

  @@index([email])
}

// ApiKey model - represents an API key for programmatic access
model ApiKey {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Key identification
  name         String    // User-provided name (e.g., "CI Pipeline", "Mobile App")
  keyPrefix    String    // First 14 characters of the key for display/lookup
  keyHash      String    // bcrypt hash of the full key

  // Ownership
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Lifecycle
  expiresAt    DateTime? // Optional expiration date
  lastUsedAt   DateTime? // Updated on each successful authentication

  @@index([userId])
  @@index([keyPrefix])
}

// Location model - represents a venue where tournaments are held
model Location {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  externalId    String?  @unique
  name          String
  address       String?
  city          String?
  state         String?
  country       String?

  // Relations
  tournaments   Tournament[]

  @@index([externalId])
  @@index([name])
  @@index([city])
}

// BlogPost model - represents a blog article
model BlogPost {
  id               String      @id @default(cuid())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Content
  title            String
  slug             String      @unique
  content          String      @db.Text
  excerpt          String?     @db.VarChar(500)

  // Status
  status           PostStatus  @default(DRAFT)
  publishedAt      DateTime?

  // Featured image (external URL)
  featuredImageUrl String?
  featuredImageAlt String?

  // SEO fields
  metaTitle        String?     @db.VarChar(60)
  metaDescription  String?     @db.VarChar(160)
  ogTitle          String?
  ogDescription    String?
  ogImageUrl       String?

  // Author (User who created the post)
  authorId         String
  author           User        @relation(fields: [authorId], references: [id], onDelete: Restrict)

  // Tags relation
  tags             BlogTag[]

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([authorId])
}

// BlogTag model - for categorizing blog posts
model BlogTag {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  name        String     @unique
  slug        String     @unique
  description String?

  // Posts with this tag
  posts       BlogPost[]

  @@index([slug])
}

// OPPR Player Ranking - OPPR-specific rating and ranking data
// Separated from Player to allow for future alternative ranking systems
model OpprPlayerRanking {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relation to Player (one-to-one)
  playerId         String   @unique
  player           Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // Glicko Rating fields
  rating           Float    @default(1500) // Glicko rating
  ratingDeviation  Float    @default(200)  // Rating uncertainty (RD)
  lastRatingUpdate DateTime @default(now())

  // World Ranking fields
  ranking          Int?                     // World ranking position (1 = best)
  isRated          Boolean  @default(false) // Has 5+ events (eligible for ranking)

  // Relations
  history          OpprRankingHistory[]

  @@index([playerId])
  @@index([rating])
  @@index([ranking])
  @@index([isRated])
}

// OPPR Ranking History - Historical record of ranking/rating changes
model OpprRankingHistory {
  id                    String   @id @default(cuid())
  createdAt             DateTime @default(now())

  // Relation to OpprPlayerRanking
  opprPlayerRankingId   String
  opprPlayerRanking     OpprPlayerRanking @relation(fields: [opprPlayerRankingId], references: [id], onDelete: Cascade)

  // Snapshot of values at this point in time
  rating                Float
  ratingDeviation       Float
  ranking               Int?
  isRated               Boolean

  // Context for the change
  changeType            OpprRankingChangeType
  tournamentId          String?
  tournament            Tournament? @relation(fields: [tournamentId], references: [id], onDelete: SetNull)
  notes                 String?  @db.VarChar(500)

  @@index([opprPlayerRankingId])
  @@index([createdAt])
  @@index([tournamentId])
  @@index([opprPlayerRankingId, createdAt])
}

// Enum for tracking what caused the ranking change
enum OpprRankingChangeType {
  INITIAL           // First ranking record created
  TOURNAMENT_RESULT // Rating updated after tournament
  RANKING_REFRESH   // Periodic ranking recalculation
  RD_DECAY          // RD increased due to inactivity
  MANUAL_ADJUSTMENT // Administrative correction
}
