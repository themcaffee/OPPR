name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., latest, v1.2.3, 1.0.0-canary.abc123)'
        required: false
        default: 'latest'
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Determine image tag
        id: tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deploying tag: ${TAG}"

      - name: Setup SSH
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Test SSH connection
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER:-root}@${{ secrets.DEPLOY_HOST }} "echo 'SSH connection successful'"

      - name: Run database migrations
        env:
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          SSH_USER: ${{ secrets.SSH_USER }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: |
          export SSH_KEY="$HOME/.ssh/deploy_key"
          chmod +x ./deploy/scripts/migrate.sh
          ./deploy/scripts/migrate.sh

      - name: Deploy to production
        env:
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          export SSH_KEY="$HOME/.ssh/deploy_key"
          chmod +x ./deploy/scripts/deploy.sh
          ./deploy/scripts/deploy.sh

      - name: Verify deployment
        run: |
          # Wait a few seconds for services to stabilize
          sleep 5

          # Check if the application is responding
          if [ -n "${{ vars.APP_URL }}" ]; then
            echo "Checking application health at ${{ vars.APP_URL }}/health"
            curl -f ${{ vars.APP_URL }}/health || echo "Warning: Health check failed, but deployment completed"
          fi

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Tag: ${{ steps.tag.outputs.tag }}"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          if [ -n "${{ vars.APP_URL }}" ]; then
            echo "URL: ${{ vars.APP_URL }}"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
